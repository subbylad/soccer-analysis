"""
AI Data Optimizer for Soccer Scout GPT-4 Integration

This module creates AI-optimized data structures that GPT-4 can directly
consume for tactical analysis and player comparisons.
"""

import pandas as pd
import numpy as np
import json
import os
from typing import Dict, List, Any, Optional
from datetime import datetime


class AIDataOptimizer:
    """Create AI-optimized data structures for GPT-4 consumption"""
    
    def __init__(self, data_dir: str = "data"):
        self.data_dir = data_dir
        self.existing_dir = f"{data_dir}/clean"
        self.comprehensive_dir = f"{data_dir}/comprehensive/processed"
        self.ai_optimized_dir = f"{data_dir}/comprehensive/ai_optimized"
        
        # Ensure AI optimized directory exists
        os.makedirs(self.ai_optimized_dir, exist_ok=True)
    
    def create_rich_player_profiles(self) -> List[Dict[str, Any]]:
        """Create rich player profiles for GPT-4 analysis"""
        print("üß† Creating rich player profiles for AI analysis...")
        
        # Load all available data
        standard_df = pd.read_csv(f"{self.existing_dir}/player_standard_clean.csv")
        passing_df = pd.read_csv(f"{self.existing_dir}/player_passing_clean.csv")
        defense_df = pd.read_csv(f"{self.existing_dir}/player_defense_clean.csv")
        shooting_df = pd.read_csv(f"{self.existing_dir}/player_shooting_clean.csv")
        
        # Load enhanced data
        possession_df = pd.read_csv(f"{self.comprehensive_dir}/player_possession_clean.csv")
        misc_df = pd.read_csv(f"{self.comprehensive_dir}/player_misc_clean.csv")
        
        # Merge all data for outfield players
        player_profiles = []\n        \n        # Get unique players from standard data\n        for idx, player_row in standard_df.iterrows():\n            if pd.isna(player_row['player']) or player_row['player'] == '':\n                continue\n                \n            player_id = f\"{player_row['player']}_{player_row['team']}\".replace(' ', '_').lower()\n            \n            # Create comprehensive player profile\n            profile = {\n                \"player_id\": player_id,\n                \"basic_info\": {\n                    \"name\": player_row['player'],\n                    \"team\": player_row['team'],\n                    \"league\": player_row['league'],\n                    \"position\": player_row.get('position', 'Unknown'),\n                    \"age\": player_row.get('age', 0),\n                    \"nationality\": player_row.get('nationality', 'Unknown')\n                },\n                \"performance_summary\": self._generate_performance_summary(player_row),\n                \"tactical_attributes\": self._calculate_tactical_attributes(player_row, idx, standard_df, passing_df, defense_df, shooting_df),\n                \"enhanced_metrics\": self._get_enhanced_metrics(player_row, possession_df, misc_df),\n                \"ai_insights\": self._generate_ai_insights(player_row),\n                \"comparable_players\": [],  # Will be filled later\n                \"scout_notes\": self._generate_scout_notes(player_row)\n            }\n            \n            player_profiles.append(profile)\n            \n            # Limit to first 100 players for demonstration\n            if len(player_profiles) >= 100:\n                break\n        \n        # Save player profiles\n        profiles_file = f\"{self.ai_optimized_dir}/rich_player_profiles.json\"\n        with open(profiles_file, 'w') as f:\n            json.dump(player_profiles, f, indent=2)\n        \n        print(f\"‚úÖ Created {len(player_profiles)} rich player profiles\")\n        print(f\"üíæ Saved to: {profiles_file}\")\n        \n        return player_profiles\n    \n    def _generate_performance_summary(self, player_row: pd.Series) -> str:\n        \"\"\"Generate AI-friendly performance summary\"\"\"\n        position = player_row.get('position', 'Player')\n        goals = player_row.get('goals', 0)\n        assists = player_row.get('assists', 0)\n        minutes = player_row.get('minutes', 0)\n        \n        if position == 'Goalkeeper':\n            return f\"Goalkeeper with {minutes} minutes played this season.\"\n        elif 'Forward' in str(position):\n            return f\"Forward with {goals} goals and {assists} assists in {minutes} minutes.\"\n        elif 'Midfielder' in str(position):\n            return f\"Midfielder contributing {goals} goals and {assists} assists across {minutes} minutes.\"\n        elif 'Defender' in str(position):\n            return f\"Defender with {goals} goals and {assists} assists, {minutes} minutes played.\"\n        else:\n            return f\"Player with {goals} goals and {assists} assists in {minutes} minutes.\"\n    \n    def _calculate_tactical_attributes(self, player_row: pd.Series, idx: int, \n                                     standard_df: pd.DataFrame, passing_df: pd.DataFrame,\n                                     defense_df: pd.DataFrame, shooting_df: pd.DataFrame) -> Dict[str, float]:\n        \"\"\"Calculate normalized tactical attributes for AI analysis\"\"\"\n        \n        # Find matching rows in other datasets\n        player_name = player_row['player']\n        team_name = player_row['team']\n        \n        passing_row = passing_df[(passing_df['player'] == player_name) & (passing_df['team'] == team_name)]\n        defense_row = defense_df[(defense_df['player'] == player_name) & (defense_df['team'] == team_name)]\n        shooting_row = shooting_df[(shooting_df['player'] == player_name) & (shooting_df['team'] == team_name)]\n        \n        # Calculate normalized attributes (0-10 scale)\n        attributes = {\n            \"attacking_threat\": self._normalize_metric(player_row.get('goals_per_90', 0), 0, 1.5, 10),\n            \"creativity\": self._normalize_metric(\n                passing_row['assists_per_90'].iloc[0] if not passing_row.empty else 0, 0, 0.8, 10\n            ),\n            \"passing_ability\": self._normalize_metric(\n                passing_row['pass_completion_pct'].iloc[0] if not passing_row.empty else 0, 70, 95, 10\n            ),\n            \"defensive_work\": self._normalize_metric(\n                defense_row['tackles_plus_interceptions'].iloc[0] if not defense_row.empty else 0, 0, 8, 10\n            ),\n            \"shooting_accuracy\": self._normalize_metric(\n                shooting_row['shot_accuracy'].iloc[0] if not shooting_row.empty else 0, 20, 60, 10\n            ),\n            \"work_rate\": self._normalize_metric(player_row.get('minutes', 0), 500, 3000, 10),\n            \"experience\": self._normalize_metric(player_row.get('age', 0), 16, 35, 10)\n        }\n        \n        return {k: round(v, 1) for k, v in attributes.items()}\n    \n    def _normalize_metric(self, value: float, min_val: float, max_val: float, scale: float = 10) -> float:\n        \"\"\"Normalize a metric to 0-scale range\"\"\"\n        if pd.isna(value) or value == 0:\n            return 0.0\n        \n        normalized = (value - min_val) / (max_val - min_val)\n        return max(0, min(scale, normalized * scale))\n    \n    def _get_enhanced_metrics(self, player_row: pd.Series, \n                            possession_df: pd.DataFrame, misc_df: pd.DataFrame) -> Dict[str, Any]:\n        \"\"\"Get enhanced metrics for the player\"\"\"\n        player_name = player_row['player']\n        team_name = player_row['team']\n        \n        enhanced = {\n            \"possession_metrics\": {},\n            \"behavioral_metrics\": {},\n            \"availability\": \"partial\"  # Since not all players have enhanced data\n        }\n        \n        # Try to find possession data\n        possession_match = possession_df[\n            (possession_df['player'] == player_name) & (possession_df['team'] == team_name)\n        ]\n        \n        if not possession_match.empty:\n            pos_row = possession_match.iloc[0]\n            enhanced[\"possession_metrics\"] = {\n                \"touches_per_90\": pos_row.get('touches_touches', 0) / max(1, pos_row.get('90s', 1)),\n                \"dribble_success_rate\": pos_row.get('take-ons_succ%', 0),\n                \"progressive_carries\": pos_row.get('carries_prgc', 0)\n            }\n            enhanced[\"availability\"] = \"full\"\n        \n        return enhanced\n    \n    def _generate_ai_insights(self, player_row: pd.Series) -> List[str]:\n        \"\"\"Generate AI-friendly insights about the player\"\"\"\n        insights = []\n        \n        # Performance insights\n        goals_per_90 = player_row.get('goals_per_90', 0)\n        if goals_per_90 > 0.5:\n            insights.append(f\"High goal threat with {goals_per_90:.2f} goals per 90 minutes\")\n        \n        assists_per_90 = player_row.get('assists_per_90', 0)\n        if assists_per_90 > 0.3:\n            insights.append(f\"Creative playmaker with {assists_per_90:.2f} assists per 90 minutes\")\n        \n        # Age-based insights\n        age = player_row.get('age', 0)\n        if age < 21:\n            insights.append(\"Young prospect with development potential\")\n        elif age > 30:\n            insights.append(\"Experienced player providing leadership and stability\")\n        \n        # Playing time insights\n        minutes = player_row.get('minutes', 0)\n        if minutes > 2500:\n            insights.append(\"Key player with high playing time\")\n        elif minutes < 500:\n            insights.append(\"Squad rotation player or recent signing\")\n        \n        return insights\n    \n    def _generate_scout_notes(self, player_row: pd.Series) -> str:\n        \"\"\"Generate scout-style notes for AI consumption\"\"\"\n        position = player_row.get('position', 'Player')\n        age = player_row.get('age', 0)\n        goals = player_row.get('goals', 0)\n        assists = player_row.get('assists', 0)\n        \n        if 'Forward' in str(position):\n            return f\"{age}-year-old forward with {goals} goals this season. {'Prolific scorer' if goals > 10 else 'Developing striker'} showing {'high' if assists > 5 else 'moderate'} creativity.\"\n        elif 'Midfielder' in str(position):\n            return f\"{age}-year-old midfielder balancing {goals} goals and {assists} assists. {'Key playmaker' if assists > 8 else 'Box-to-box midfielder'} with {'strong' if goals > 5 else 'moderate'} attacking output.\"\n        elif 'Defender' in str(position):\n            return f\"{age}-year-old defender contributing {goals + assists} goal involvements. {'Attacking threat' if goals + assists > 3 else 'Solid defender'} from defensive positions.\"\n        else:\n            return f\"{age}-year-old player with {goals} goals and {assists} assists this season.\"\n    \n    def create_tactical_attributes_matrix(self) -> pd.DataFrame:\n        \"\"\"Create matrix of tactical attributes for all players\"\"\"\n        print(\"‚öΩ Creating tactical attributes matrix...\")\n        \n        standard_df = pd.read_csv(f\"{self.existing_dir}/player_standard_clean.csv\")\n        \n        # Create tactical attributes for all players\n        tactical_data = []\n        \n        for idx, player_row in standard_df.iterrows():\n            if pd.isna(player_row['player']) or player_row['player'] == '':\n                continue\n                \n            # Load other data for this player\n            passing_df = pd.read_csv(f\"{self.existing_dir}/player_passing_clean.csv\")\n            defense_df = pd.read_csv(f\"{self.existing_dir}/player_defense_clean.csv\")\n            shooting_df = pd.read_csv(f\"{self.existing_dir}/player_shooting_clean.csv\")\n            \n            attributes = self._calculate_tactical_attributes(\n                player_row, idx, standard_df, passing_df, defense_df, shooting_df\n            )\n            \n            tactical_row = {\n                'player': player_row['player'],\n                'team': player_row['team'],\n                'position': player_row.get('position', 'Unknown'),\n                'age': player_row.get('age', 0),\n                **attributes\n            }\n            \n            tactical_data.append(tactical_row)\n            \n            # Limit for demonstration\n            if len(tactical_data) >= 500:\n                break\n        \n        tactical_df = pd.DataFrame(tactical_data)\n        \n        # Save tactical attributes\n        tactical_file = f\"{self.ai_optimized_dir}/tactical_attributes.csv\"\n        tactical_df.to_csv(tactical_file, index=False)\n        \n        print(f\"‚úÖ Created tactical attributes for {len(tactical_df)} players\")\n        print(f\"üíæ Saved to: {tactical_file}\")\n        \n        return tactical_df\n    \n    def create_gpt4_query_examples(self) -> Dict[str, Any]:\n        \"\"\"Create example queries optimized for GPT-4 analysis\"\"\"\n        examples = {\n            \"timestamp\": datetime.now().isoformat(),\n            \"tactical_queries\": [\n                {\n                    \"query\": \"Find midfielders similar to Pedri's playing style\",\n                    \"data_requirements\": [\"passing_ability\", \"creativity\", \"work_rate\", \"age\"],\n                    \"analysis_type\": \"similarity_matching\",\n                    \"expected_response\": \"Young creative midfielders with high pass completion and assist rates\"\n                },\n                {\n                    \"query\": \"Who can replace Rodri in Manchester City's system?\",\n                    \"data_requirements\": [\"defensive_work\", \"passing_ability\", \"tactical_attributes\"],\n                    \"analysis_type\": \"position_specific_replacement\",\n                    \"expected_response\": \"Defensive midfielders with similar tactical profile and system fit\"\n                },\n                {\n                    \"query\": \"Find the best young prospects under 21 for each position\",\n                    \"data_requirements\": [\"age\", \"tactical_attributes\", \"performance_metrics\"],\n                    \"analysis_type\": \"prospect_identification\",\n                    \"expected_response\": \"Top young players by position with development potential\"\n                }\n            ],\n            \"data_structure_info\": {\n                \"rich_profiles\": \"JSON format with comprehensive player data\",\n                \"tactical_attributes\": \"CSV matrix with normalized 0-10 tactical scores\",\n                \"enhanced_metrics\": \"Additional FBref data for detailed analysis\"\n            },\n            \"ai_optimization_features\": [\n                \"Normalized tactical attributes (0-10 scale)\",\n                \"Human-readable performance summaries\",\n                \"Scout-style insights and notes\",\n                \"Structured data for consistent AI parsing\",\n                \"Multi-dimensional player profiling\"\n            ]\n        }\n        \n        # Save GPT-4 examples\n        examples_file = f\"{self.ai_optimized_dir}/gpt4_query_examples.json\"\n        with open(examples_file, 'w') as f:\n            json.dump(examples, f, indent=2)\n        \n        print(f\"‚úÖ Created GPT-4 query examples\")\n        print(f\"üíæ Saved to: {examples_file}\")\n        \n        return examples\n    \n    def optimize_all_data_for_ai(self) -> Dict[str, str]:\n        \"\"\"Run complete AI optimization process\"\"\"\n        print(\"\\n\" + \"=\"*60)\n        print(\"üß† AI DATA OPTIMIZATION FOR GPT-4 INTEGRATION\")\n        print(\"=\"*60)\n        \n        # Create all AI-optimized structures\n        profiles = self.create_rich_player_profiles()\n        tactical_matrix = self.create_tactical_attributes_matrix()\n        gpt4_examples = self.create_gpt4_query_examples()\n        \n        # Create optimization summary\n        summary = {\n            \"rich_player_profiles\": f\"{self.ai_optimized_dir}/rich_player_profiles.json\",\n            \"tactical_attributes\": f\"{self.ai_optimized_dir}/tactical_attributes.csv\",\n            \"gpt4_examples\": f\"{self.ai_optimized_dir}/gpt4_query_examples.json\",\n            \"optimization_complete\": True,\n            \"profiles_created\": len(profiles),\n            \"tactical_matrix_size\": tactical_matrix.shape,\n            \"ai_ready\": True\n        }\n        \n        # Save summary\n        summary_file = f\"{self.ai_optimized_dir}/ai_optimization_summary.json\"\n        with open(summary_file, 'w') as f:\n            json.dump(summary, f, indent=2)\n        \n        print(f\"\\n‚úÖ AI OPTIMIZATION COMPLETE!\")\n        print(f\"üìÅ AI-optimized data saved to: {self.ai_optimized_dir}\")\n        print(f\"üß† Rich profiles: {len(profiles)} players\")\n        print(f\"‚öΩ Tactical matrix: {tactical_matrix.shape}\")\n        print(f\"üéØ Ready for GPT-4 enhanced tactical analysis!\")\n        \n        return summary\n\n\nif __name__ == \"__main__\":\n    optimizer = AIDataOptimizer()\n    optimization_results = optimizer.optimize_all_data_for_ai()